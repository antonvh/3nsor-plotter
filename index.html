<!--
########################################################################                                                                 
# Program Name: Browser_Client_Coder.html                                     
# ================================     
# This code is for controlling a robot by a web browser using web sockets                            
#
########################################################################
-->
<!-- This code implements the web socket connection between client(web page on a Computer) and a server(raspberry pi) -->
<!-- It sends data from web page using buttons and Keyboard presses to control the BrickPi robot
TODO: Refactor so setup isn't run every time. Refactor so a dictionary with states is sent over on change.
TODO: Add a manual connect/disconnect/setup button. Or monitor.
-->

<!DOCTYPE html>
<html>
<head>
  <title>WebSockets Client</title>
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc= sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
        crossorigin="anonymous">

  <style>h1,h2 { font-family: ‘Metrophobic’, Arial, serif; font-weight: 700; }</style>
</head>

<body>
<div class="container">
  <h1>3nsor plotter robot</h1>

  <div class="row">
    <div class="col-md-8">
      <div class="row">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3>Manual controls</h3>
          </div>
          <div class="controls panel-body">
            <button class="btn btn-default" data-msg="lmf">Left motor forward</button>
            <button class="btn btn-default" data-msg="lmb">Left motor back</button>
            <button class="btn btn-default" data-msg="rmf">Right motor forward</button>
            <button class="btn btn-default" data-msg="rmb">Right motor back</button>
            <button class="btn btn-default" data-msg="pu">Pen up</button>
            <button class="btn btn-default" data-msg="pd">Pen down</button>
            <button class="btn btn-default" data-msg="zero">Set motor zeros</button>
            <button class="btn btn-default" data-msg="plot">Plot coords.csv</button>
            <button class="btn btn-default" data-msg="plotcircles">Plot circles</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3>Settings</h3>
          </div>
          <div class="panel-body">
            <form class="form-inline" id="pid">
              <div class="form-group">
                <label> Proportional factor </label>
                <input type="text" id="kp" size="10" value="3"/><br>
              </div>
              <div class="form-group">
                <label> Enter integral factor</label>
                <input type="text" id="ki" size="10"/><br>
              </div>
              <div class="form-group">
                <label> Enter derivative factor </label>
                <input type="text" id="kd" size="10"/><br>

              </div>
              <button id="sendPID" class="btn btn-primary">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3>Messages from server</h3>
        </div>
        <div id="output" class="panel-body">
          <p>No message from Brick Pi...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
    function SocketController() {
        var name = window.location.host;
        this.host =  "ws://"+name+"/ws"; 	// combines the three string and creates a new string
	      //this.socket = new WebSocket(this.host);
    }

    function showServerResponse(txt)
	  {
	      var output = document.getElementById('output')
		    var pre = document.createElement("p");
		    pre.style.wordWrap = "break-word";
		    pre.innerHTML = txt;
		    output.appendChild(pre);
	  }

    SocketController.prototype.getSocket = function () {
        if (!(this.socket)){
            this.socket = new WebSocket(this.host);
            this.socket.onopen = function(evt) {
                this.socketopen = true;
                showServerResponse("Socket has been opened.");
                };
            this.socket.onclose = function(evt) { showServerResponse("The connection has been closed."); };
            this.socket.onmessage = function(evt) { showServerResponse(evt.data); };
            this.socket.onerror = function(evt) { showServerResponse(evt.data); };
            }
         return this.socket;
    }


    // Make the function wait until the connection is made...
    waitForSocketConnection = function (socket, callback){
        setTimeout(
            function () {
                if (socket.readyState === 1) {
                    //console.log("Connection is made")
                    if(callback != null){
                        callback(socket);
                    }
                    return;

                } else {
                    console.log("wait for connection...")
                    waitForSocketConnection(socket, callback);
                }

            }, 5); // wait 5 milisecond for the connection...
    }

    SocketController.prototype.send = function (command) {
        // Wait until the state of the socket is not ready and send the message when it is...
        waitForSocketConnection(this.getSocket(), function(socket){
            //console.log("message sent!!!");
            socket.send(command)
        });
    }





    var brickpi_socket = new SocketController();

    $('.controls').on('click', 'button', function (event) {
        event.preventDefault();
        brickpi_socket.send($(this).data('msg'));
    });

    document.body.addEventListener('keydown', function (event) {
        var KeyID = event.keyCode;
				switch(KeyID)
				{
				case 16: //shift key
				command = "stop";
				console.log("shift")
				break;
				case 17: //ctrl key
				command = "stop";
				break;
				case 37: //left arrow
				command = "lmb";
				break;
				case 38: //up arrow
				command = "rmf";
				break;
				case 39: //right arrow
				command = "lmf";
				break;
				case 40: //down arrow
				command = "rmb";
				break;
				case "o".charCodeAt():
				command = "zero";
				break;
				case "p".charCodeAt():
				command = "plot";
				break;
				default:
				command = "";
				}
				brickpi_socket.send(command);
    });

}());


//	var pidcmd = "PID("+$("#kp").val()+","+$("#ki").val()+","+$("#ki").val()+")"

//	console.log(pidcmd);


















</script>
</body>
</html>
<script>   

jQuery(function($)
{
  if (!("WebSocket" in window)) 
  {
    alert("Your browser does not support web sockets");
  }
});


















</script>