<!--
########################################################################                                                                 
# Program Name: Browser_Client_Coder.html                                     
# ================================     
# This code is for controlling a robot by a web browser using web sockets                            
#
########################################################################
-->
<!-- This code implements the web socket connection between client(web page on a Computer) and a server(raspberry pi) -->
<!-- It sends data from web page using buttons and Keyboard presses to control the BrickPi robot
TODO: Refactor so setup isn't run every time. Refactor so a dictionary with states is sent over on change.
TODO: Add a manual connect/disconnect/setup button. Or monitor.
-->

<!DOCTYPE html>
<html>
<head>
  <title>WebSockets Client</title>
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc= sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
        crossorigin="anonymous">

  <style>h1,h2 { font-family: ‘Metrophobic’, Arial, serif; font-weight: 700; }</style>
</head>

<body>
<div class="container">
  <h1>3nsor plotter robot</h1>

  <div class="row" style="display: flex;">
    <div class="col-md-8">
      <div class="row">
        <div class="col-md-12">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3>Manual controls</h3>
            </div>
            <div class="controls panel-body">
              <table class="table">
                <thead>
                <tr>
                  <th>Left motor</th>
                  <th>Right motor</th>
                  <th>Pen</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                  <td>
                    <button class="btn btn-default" data-down="left-fwd" data-up="left-stop"><span
                            class="glyphicon glyphicon-arrow-up"/> [q]
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-default" data-down="right-fwd" data-up="right-stop"><span
                            class="glyphicon glyphicon-arrow-up"/> [w]
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-default" data-down="" data-up="pu"><span
                            class="glyphicon glyphicon-remove-circle"/> [e]
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <button class="btn btn-default" data-down="left-back" data-up="left-stop"><span
                            class="glyphicon glyphicon-arrow-down"/> [a]
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-default" data-down="right-back" data-up="right-stop"><span
                            class="glyphicon glyphicon-arrow-down"/> [s]
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-default" data-down="" data-up="pd"><span
                            class="glyphicon glyphicon-ok-circle"/> [d]
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
              <button class="btn btn-default" data-msg="zero">Set motor zeros</button>
              <button class="btn btn-default" data-msg="plot">Plot coords.csv</button>
              <button class="btn btn-default" data-msg="plotcircles">Plot circles</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3>PID Settings</h3>
            </div>
            <div class="panel-body">
              <img src="static/pid.png">

              <form class="form-inline" id="pid" action="" method="post">
                <div class="form-group">
                  <label> Kp </label>
                  <input type="text" name="kp" size="10" value="{{ Kp }}"/>
                </div>
                <div class="form-group">
                  <label> Ki </label>
                  <input type="text" name="ti"  size="10" value="{{ Ki }}"/>
                </div>
                <div class="form-group">
                  <label> Kd </label>
                  <input type="text" name="td" size="10" value="{{ Kd }}"/>
                </div>
                <button id="sendPID" type="submit" class="btn btn-primary">Send</button>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3>Plotter Settings</h3>
            </div>
            <div class="panel-body">
              <img src="static/schematic.png">

              <form class="form-inline" id="plot" action="" method="post">


                <div class="form-group">
                  <label> Left rope length at 0,0 </label>
                  <input type="text" name="ll" size="10" value="{{ ll }}"/><br>
                </div>
                <div class="form-group">
                  <label> Right rope length at 0,0 </label>
                  <input type="text" name="lr" size="10" value="{{ lr }}"/>
                </div>
                <div class="form-group">
                  <label> Width between rope attachments </label>
                  <input type="text" name="aw" size="10" value="{{ aw }}"/>
                </div>
                <button id="sendPlot" type="submit" class="btn btn-primary">Send</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4" style="display: flex;">
      <div class="panel panel-default" style="flex:1; ">
        <div class="panel-heading">
          <h3>Messages from server</h3>
        </div>
        <div id="output" class="panel-body">
          <p>No message from Brick Pi...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() { //this statement defines a function and executes it right away. Everything inside is scoped this way.

    function SocketController() {
        //the "class" for controlling the everything about the socket on this page.
        var name = window.location.host;
        this.host =  "ws://"+name+"/ws";
    }

    function showServerResponse(txt)
	  {
	      $('#output').append($("<p>", { //get element and append a <p> to it
		        'html': txt                  //inside the p put html containing the response txt
		    }));
	  }

    SocketController.prototype.getSocket = function () {
        // Get socket if there is one, or open a new one.
        if (!(this.socket)){
            this.socket = new WebSocket(this.host);
            this.socket.onopen = function(evt) {
                showServerResponse("Socket has been opened.");
                };
            this.socket.onclose = function(evt) {
                showServerResponse("The connection has been closed.");
                };
            this.socket.onmessage = function(evt) { showServerResponse(evt.data); };
            this.socket.onerror = function(evt) { showServerResponse(evt.data); };
            }
         return this.socket;
    }


    // Make the function wait until the connection is made...
    waitForSocketConnection = function (socket, callback){
        setTimeout(
            function () {
                if (socket.readyState === 1) {
                    //console.log("Connection is made")
                    if(callback != null){
                        callback(socket); //pass the opened socket as an argument to the callback, usually the send function.
                    }
                    return;

                } else {
                    //console.log("wait for connection...")
                    waitForSocketConnection(socket, callback);
                }

            }, 5); // wait 5 milisecond for the connection...
    }

    SocketController.prototype.send = function (command) {
        // Wait until the state of the socket is ready and send the message when it is...
        waitForSocketConnection(this.getSocket(), function(socket){
            socket.send(JSON.stringify(command)); //always convert to JSON, that's what server expects.
        });
    }





    var brickpi_socket = new SocketController();

    $('.controls').on('mousedown', 'button', function (event) {
        event.preventDefault();
        var command = $(this).data('down')
        brickpi_socket.send(command);
        console.log(command);
    });

    $('.controls').on('mouseup', 'button', function (event) {
        event.preventDefault();
        var command = $(this).data('up')
        brickpi_socket.send(command);
        console.log(command);
    });



    $(document.body).on('keydown', function (event)  {
        var KeyID = event.keyCode;
				command = ""
				//console.log(KeyID);
				switch(KeyID)
				{
				case 16: //shift key
				break;
				case 17: //ctrl key
				break;
				case 37: //left arrow
				break;
				case 38: //up arrow
				break;
				case 39: //right arrow
				break;
				case 40: //down arrow
				break;
				case 81: //q
				command = "left-fwd";
				break;
				case 65: //a
				command = "left-back";
				break;
				case 87: //w
				command = "right-fwd";
				break;
				case 83: //s
				command = "right-back";
				break;
				default:
				command = "";
				}
				console.log(command);
				if (command) {
				    brickpi_socket.send(command);
				}
    });

    $(document.body).on('keyup', function (event)  {
        var KeyID = event.keyCode;
				switch(KeyID)
				{
        case 81:
				command = "left-stop";
				break;
				case 65:
				command = "left-stop";
				break;
				case 87:
				command = "right-stop";
				break;
				case 83:
				command = "right-stop";
				break;
				case 69: //e
				command = "pu";
				break;
				case 68: //d
				command = "pd";
				break;
				case 79: //o
				command = "zero";
				break;
				case 80: //p
				command = "plot";
				break;
				default:
				command = "";
				}
				console.log(command);
				if (command) {
				    brickpi_socket.send(command);
				}
    });


    $.fn.serializeObject = function()
    {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    return o;
    };

    $('#pid').submit(function(evt) {
        evt.preventDefault();
        command = $('#pid').serializeObject();
        console.log(command);
        brickpi_socket.send(command);
        return false;
    });

    $('#plot').submit(function(evt) {
        evt.preventDefault();
        command = $('#plot').serializeObject();
        console.log(command);
        brickpi_socket.send(command);
        return false;
    });
}());


//	var pidcmd = "PID("+$("#kp").val()+","+$("#ki").val()+","+$("#ki").val()+")"

//	console.log(pidcmd);
























</script>
</body>
</html>
<script>   

jQuery(function($)
{
  if (!("WebSocket" in window)) 
  {
    alert("Your browser does not support web sockets");
  }
});
























</script>